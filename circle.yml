machine:
  services:
    - postgresql
    - docker
  environment:
    DATABASE_NAME: "circle_test"
    DATABASE_USERNAME: "ubuntu"
    DATABASE_PASSWORD: ""

dependencies:
  pre:
    - go get github.com/tools/godep
    - go get github.com/jteeuwen/go-bindata/...
  post:
    - make assets -B
test:
  override:
      - case $CIRCLE_NODE_INDEX in 0) go test -tags bindata ./controllers/... -v -race ;; 1) go test -tags bindata -v -race ./models/... ./database/... ./helpers/... ./config/... ;; esac:
          parallel: true
deployment:
  master:
    branch: master
    commands:
      - mkdir binaries
      - make -B
      - cp Helen binaries/helen-prod
      - cp binaries/helen-prod $CIRCLE_ARTIFACTS/helen 
      - rsync -rl -e "ssh -p $SSH_PORT" binaries/* $BACKEND_USER@tf2stadium.com:$BACKEND_DEPLOY_PATH_PROD
      - ssh -p $SSH_PORT $BACKEND_USER@tf2stadium.com $BACKEND_DEPLOY_SCRIPT_PROD
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
      - make docker -B
      - docker push tf2stadium/helen
  dev:
    branch: dev
    commands:
      - mkdir binaries
      - make -B
      - cp Helen binaries/helen-dev
      - cp binaries/helen-dev $CIRCLE_ARTIFACTS/helen
      - rsync -rl -e "ssh -p $SSH_PORT" binaries/* $BACKEND_USER@tf2stadium.com:$BACKEND_DEPLOY_PATH_DEV
      - ssh -p $SSH_PORT $BACKEND_USER@tf2stadium.com $BACKEND_DEPLOY_SCRIPT_DEV
      - make cover -B
